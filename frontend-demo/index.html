<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamic-Knowledge-Graph-Demo</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="header">
      <h2>Dynamic-Knowledge-Graph-Demo</h2>
      <button id="gearButton" title="Settings">‚öôÔ∏è</button>
    </div>

    <div id="apiPrompt">
      <label for="apiKey">Enter OpenAI API Key:</label>
      <div class="inputRow">
        <input type="password" id="apiKey" placeholder="sk-..." />
        <button id="setApiKey">Save</button>
      </div>
    </div>

    <div id="chatContainer"></div>

    <div id="inputArea">
      <div class="inputWrapper">
        <textarea id="userInput" rows="1" placeholder="Type a message..."></textarea>
        <button id="runButton" title="Send">‚û§</button>
      </div>
    </div>

    <script type="module">
      import { handleUserInput } from './script.js?cachebust=1';
      import { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js';

      const userInputField = document.getElementById('userInput');
      const runButton = document.getElementById('runButton');
      const chatContainer = document.getElementById('chatContainer');
      const apiPrompt = document.getElementById('apiPrompt');
      const apiKeyInput = document.getElementById('apiKey');
      const setApiKeyBtn = document.getElementById('setApiKey');
      const gearButton = document.getElementById('gearButton');

      const storedKey = localStorage.getItem('OPENAI_API_KEY');
      if (storedKey && storedKey.startsWith('sk-')) {
        apiPrompt.style.display = 'none';
      } else {
        apiPrompt.style.display = 'block';
      }

      setApiKeyBtn.addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        if (!key.startsWith('sk-')) {
          alert('Invalid key format');
          return;
        }
        localStorage.setItem('OPENAI_API_KEY', key);
        apiPrompt.style.display = 'none';
      });

      gearButton.addEventListener('click', () => {
        apiPrompt.style.display =
          apiPrompt.style.display === 'block' ? 'none' : 'block';
      });

      function appendMessage(text, isUser = false, isExpandable = false, expandedContent = '') {
        const msg = document.createElement('div');
        msg.className = 'message ' + (isUser ? 'user' : 'bot');
        msg.innerHTML = marked.parse(text);

        if (isExpandable) {
          msg.style.cursor = 'pointer';
          let expanded = false;
          msg.addEventListener('click', () => {
            if (!expanded) {
              msg.innerHTML = marked.parse(expandedContent);
              msg.style.cursor = 'default';
              msg.classList.remove('placeholder');
              expanded = true;
            }
          });
        }

        chatContainer.appendChild(msg);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      async function sendMessage() {
        const input = userInputField.value.trim();
        if (!input) return;

        appendMessage(input, true);
        userInputField.value = '';
        autoResize();

        let expandablePlaceholder = document.createElement('div');
        expandablePlaceholder.className = 'message bot placeholder';
        expandablePlaceholder.innerHTML = marked.parse('Thinking... (click to expand)');
        expandablePlaceholder.style.cursor = 'pointer';
        chatContainer.appendChild(expandablePlaceholder);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
          const { reflection, prompt1, prompt1_5 } = await handleUserInput(input);
          const expandedContent = `## üß† Initial Reasoning\n${prompt1}\n\n## üîó Graph Connecting Phase\n${prompt1_5}`;

          // Add expandable click once
          let expanded = false;
          expandablePlaceholder.addEventListener('click', () => {
            if (!expanded) {
              expandablePlaceholder.innerHTML = marked.parse(expandedContent);
              expandablePlaceholder.style.cursor = 'default';
              expandablePlaceholder.classList.remove('placeholder');
              expanded = true;
            }
          });

          // Always add final reflection separately
          appendMessage(reflection, false);
        } catch (err) {
          expandablePlaceholder.textContent = 'Error: ' + err.message;
          console.error(err);
        }
      }

      runButton.addEventListener('click', sendMessage);

      userInputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      function autoResize() {
        userInputField.style.height = 'auto';
        userInputField.style.height = userInputField.scrollHeight + 'px';
      }

      userInputField.addEventListener('input', autoResize);
    </script>
  </body>
</html>
